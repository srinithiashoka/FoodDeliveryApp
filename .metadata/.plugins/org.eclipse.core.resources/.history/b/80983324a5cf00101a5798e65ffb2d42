package com.foodapp.dao.impl;

import com.foodapp.dao.CartDAO;
import com.foodapp.model.Cart;
import com.foodapp.model.CartItem;
import com.foodapp.util.DBConnection;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

public class CartDAOImpl implements CartDAO {


	@Override
	public boolean addOrUpdateCart(int userId, int menuId, int quantity) {
	    if (menuId <= 0) {
	        System.out.println("Invalid menuId: " + menuId);
	        return false;
	    }

	    if (quantity <= 0) {
	        System.out.println("Quantity <= 0, removing from cart");
	        return removeFromCart(userId, menuId);
	    }

	    String checkSql = "SELECT quantity FROM cart WHERE userId=? AND menuId=?";
	    String insertSql = "INSERT INTO cart (userId, menuId, quantity) VALUES (?, ?, ?)";
	    String updateSql = "UPDATE cart SET quantity = quantity + ? WHERE userId=? AND menuId=?";

	    try (Connection conn = DBConnection.getConnection()) {
	        PreparedStatement psCheck = conn.prepareStatement(checkSql);
	        psCheck.setInt(1, userId);
	        psCheck.setInt(2, menuId);
	        ResultSet rs = psCheck.executeQuery();

	        if (rs.next()) {
	            System.out.println("Item exists, updating quantity...");
	            PreparedStatement psUpdate = conn.prepareStatement(updateSql);
	            psUpdate.setInt(1, quantity);
	            psUpdate.setInt(2, userId);
	            psUpdate.setInt(3, menuId);
	            int rows = psUpdate.executeUpdate();
	            System.out.println("Rows updated: " + rows);
	            return rows > 0;
	        } else {
	            System.out.println("Item does not exist, inserting...");
	            PreparedStatement psInsert = conn.prepareStatement(insertSql);
	            psInsert.setInt(1, userId);
	            psInsert.setInt(2, menuId);
	            psInsert.setInt(3, quantity);
	            int rows = psInsert.executeUpdate();
	            System.out.println("Rows inserted: " + rows);
	            return rows > 0;
	        }
	    } catch (Exception e) {
	        e.printStackTrace();
	        System.out.println("Cart update failed due to exception");
	    }
	    return false;
	}

@Override
public boolean removeFromCart(int userId, int menuId) {
    String sql = "DELETE FROM cart WHERE userId=? AND menuId=?";
    try (Connection conn = DBConnection.getConnection();
         PreparedStatement ps = conn.prepareStatement(sql)) {
        ps.setInt(1, userId);
        ps.setInt(2, menuId);
        return ps.executeUpdate() > 0;
    } catch (Exception e) {
        e.printStackTrace();
    }
    return false;
}

@Override
public boolean updateCart(Cart cart) {
    String sql = "UPDATE cart SET quantity=? WHERE cartId=?";
    try (Connection conn = DBConnection.getConnection();
         PreparedStatement ps = conn.prepareStatement(sql)) {
        ps.setInt(1, cart.getQuantity());
        ps.setInt(2, cart.getCartId());
        return ps.executeUpdate() > 0;
    } catch (Exception e) {
        e.printStackTrace();
    }
    return false;
}

@Override
public boolean deleteCartItem(int cartId) {
    String sql = "DELETE FROM cart WHERE cartId=?";
    try (Connection conn = DBConnection.getConnection();
         PreparedStatement ps = conn.prepareStatement(sql)) {
        ps.setInt(1, cartId);
        return ps.executeUpdate() > 0;
    } catch (Exception e) {
        e.printStackTrace();
    }
    return false;
}

@Override
public List<CartItem> getCartByUser(int userId) {
    List<CartItem> list = new ArrayList<>();
    String sql = """
        SELECT c.cartId, c.menuId, c.quantity,
               m.itemName, m.imagePath, m.price
        FROM cart c
        JOIN menu m ON c.menuId = m.menuId
        WHERE c.userId = ?
    """;

    try (Connection conn = DBConnection.getConnection();
         PreparedStatement ps = conn.prepareStatement(sql)) {
        ps.setInt(1, userId);
        ResultSet rs = ps.executeQuery();
        while (rs.next()) {
            CartItem item = new CartItem();
            item.setCartId(rs.getInt("cartId"));
            item.setMenuId(rs.getInt("menuId"));
            item.setQuantity(rs.getInt("quantity"));
            item.setFoodName(rs.getString("itemName"));
            item.setFoodImage(rs.getString("imagePath"));
            item.setPrice(rs.getDouble("price"));
            list.add(item);
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
    return list;
}

@Override
public boolean clearCartByUserId(int userId) {
    String sql = "DELETE FROM cart WHERE userId=?";
    try (Connection conn = DBConnection.getConnection();
         PreparedStatement ps = conn.prepareStatement(sql)) {
        ps.setInt(1, userId);
        return ps.executeUpdate() > 0;
    } catch (Exception e) {
        e.printStackTrace();
    }
    return false;
}

@Override
public boolean itemExists(int userId, int menuId) {
    String sql = "SELECT 1 FROM cart WHERE userId=? AND menuId=?";
    try (Connection conn = DBConnection.getConnection();
         PreparedStatement ps = conn.prepareStatement(sql)) {
        ps.setInt(1, userId);
        ps.setInt(2, menuId);
        ResultSet rs = ps.executeQuery();
        return rs.next();
    } catch (Exception e) {
        e.printStackTrace();
    }
    return false;
}

@Override
public int getCartItemCount(int userId) {
    String sql = "SELECT COALESCE(SUM(quantity),0) FROM cart WHERE userId=?";
    try (Connection conn = DBConnection.getConnection();
         PreparedStatement ps = conn.prepareStatement(sql)) {
        ps.setInt(1, userId);
        ResultSet rs = ps.executeQuery();
        if (rs.next()) {
            return rs.getInt(1);
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
    return 0;
}


}
