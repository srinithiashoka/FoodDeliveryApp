<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.util.List"%>
<%@ page import="com.foodapp.model.Menu"%>
<%@ page import="com.foodapp.model.User"%>

<%
    @SuppressWarnings("unchecked")
    List<Menu> menuList = (List<Menu>) request.getAttribute("menuList");
    User user = (User) session.getAttribute("user");
    Integer userId = (user != null) ? user.getUserId() : null;
%>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Menu - FoodHub</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

    <!-- Merged Menu CSS -->
    <style>
        /* =======================
           RESET & GENERAL
        ====================== */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        }
        body {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            background: #f9f9f9;
            color: #333;
        }
        a { text-decoration: none; color: inherit; }
        .container { width: 90%; max-width: 1200px; margin: auto; }

        /* =======================
           HEADER
        ====================== */
        header {
            background: #ff4757;
            padding: 12px 0;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 700;
            transition: transform 0.5s ease, color 0.5s ease;
        }
        .logo:hover {
            transform: rotate(-5deg) scale(1.05);
            color: #ffeaa7;
        }
        .scooter-icon {
            font-size: 28px;
            animation: bounce 2s infinite;
            color: white;
        }
        @keyframes bounce {
            0%,100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        .nav-menu { display: flex; list-style: none; gap: 20px; }
        .nav-menu li a { font-weight: bold; color: white; transition: color 0.3s; }
        .nav-menu li a:hover { color: #ffeaa7; }
        .nav-actions {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s, transform 0.2s;
        }
        .btn-login, .btn-signup {
            background: #2ed573;
            color: white;
        }
        .btn-login:hover, .btn-signup:hover {
            background: #26c35e;
            transform: scale(1.05);
        }
        .cart-icon-wrapper { position: relative; }
        .cart-badge {
            position: absolute;
            top: -5px;
            right: -7px;
            background: #ff4757;
            color: white;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 50%;
        }

        /* =======================
           MENU ITEMS
        ====================== */
        .menu-container {
            padding: 50px 0;
            max-width: 900px;
            margin: 0 auto;
        }
        .menu-item {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .menu-image {
            background: #fff;
            padding: 8px;
            border-radius: 12px;
            width: 120px;
            height: 120px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
        }
        .menu-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 12px;
        }
        .menu-content { flex: 1; }
        .menu-header { display: flex; justify-content: space-between; align-items: center; }
        .menu-header h3 { margin: 0; font-size: 1.2rem; color: #ff4757; }
        .menu-description { margin: 5px 0 8px 0; color: #555; }
        .menu-price { font-weight: bold; margin-bottom: 8px; }

        /* Quantity Controls */
        .quantity-controls {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 6px;
            flex-wrap: wrap;
        }
        .quantity-input-display {
            width: 40px;
            height: 36px;
            text-align: center;
            border-radius: 5px;
            border: 1px solid #ccc;
            background: #f7f7f7;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        .qty-btn {
            border: none;
            background: #ddd;
            padding: 6px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        .qty-btn:hover { background: #bbb; }
        .qty-btn.clear {
            background: #ff6b81;
            color: #fff;
            font-size: 0.85rem;
            padding: 0 12px;
        }
        .btn-add {
            background: #2ed573;
            color: white;
            border: none;
            padding: 0 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.95rem;
            transition: background 0.3s;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .btn-add:hover { background: #26c35e; }
        .qty-btn.clear, .btn-add { height: 36px; }

        .back-link {
            display: inline-block;
            margin-bottom: 20px;
            font-size: 1rem;
            color: #0a3d62;
        }
        .back-link:hover { text-decoration: underline; }
        .menu-title {
            text-align: center;
            margin-bottom: 20px;
            color: #ff4757;
        }
        .no-menu-items {
            text-align: center;
            color: red;
            width: 100%;
        }

        /* Toast */
        #toast {
            visibility: hidden;
            min-width: 150px;
            max-width: 220px;
            background-color: #2ed573;
            color: white;
            text-align: center;
            border-radius: 8px;
            padding: 12px;
            position: fixed;
            z-index: 9999;
            top: 20px;
            right: 20px;
            font-size: 14px;
            opacity: 0;
            transition: opacity 0.3s, visibility 0.3s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        #toast.show { visibility: visible; opacity: 1; }

        /* FOOTER */
        footer {
            background: #2f3542;
            color: white;
            text-align: center;
            padding: 20px 0;
            font-size: 0.85rem;
            margin-top: auto;
        }

        /* RESPONSIVE */
        @media(max-width:768px){
            .nav-menu{display:none;}
            .menu-item{flex-direction:column;align-items:flex-start;}
            .menu-image{width:100%;height:200px;margin-bottom:12px;}
            .quantity-controls{flex-wrap:wrap;gap:6px;}
            .btn-add, .qty-btn.clear{flex:1 1 100%;}
        }
    </style>
</head>
<body>

<!-- HEADER -->
<header>
    <div class="container">
        <div class="navbar">
            <div class="logo">
                <i class="fa-solid fa-motorcycle scooter-icon"></i>
                <span>FoodHub</span>
            </div>
            <ul class="nav-menu">
                <li><a href="home.jsp">Home</a></li>
                <li><a href="#">Restaurants</a></li>
                <li><a href="#">Offers</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
            <div class="nav-actions">
                <% if(user == null) { %>
                    <button class="btn btn-login" onclick="location.href='login.jsp'">Login</button>
                    <button class="btn btn-signup" onclick="location.href='signup.jsp'">Sign Up</button>
                <% } else { %>
                    <span>Welcome, <%= user.getUsername() %></span>
                <% } %>
                <div class="cart-icon-wrapper">
                    <a href="cart.jsp">
                        <i class="fas fa-shopping-cart cart-icon"></i>
                    </a>
                    <span class="cart-badge"><%= session.getAttribute("cartCount") != null ? session.getAttribute("cartCount") : 0 %></span>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- MENU CONTAINER -->
<div class="container menu-container">
    <a href="home.jsp" class="back-link"><i class="fa fa-arrow-left"></i> Back to Restaurants</a>
    <h1 class="menu-title">Menu</h1>

    <% if (menuList != null && !menuList.isEmpty()) { %>
        <% for (Menu m : menuList) { %>
        <div class="menu-item menu-item-wrapper">
            <div class="menu-image">
                <img src="<%= (m.getImagePath() != null && !m.getImagePath().isEmpty()) 
                            ? m.getImagePath() 
                            : "images/restaurants/" + m.getRestaurantId() + "/" + m.getMenuId() + ".jpg" %>" 
                     alt="<%= m.getItemName() %>">
            </div>
            <div class="menu-content">
                <div class="menu-header">
                    <h3><%= m.getItemName() %></h3>
                    <span class="menu-price">₹<%= m.getPrice() %></span>
                </div>
                <p class="menu-description"><%= m.getDescription() %></p>

                <div class="quantity-controls">
                    <button type="button" class="qty-btn decrease">-</button>
                    <input type="text" value="0" class="quantity-input-display" readonly>
                    <button type="button" class="qty-btn increase">+</button>
                    <button type="button" class="btn-add" <%= !m.isAvailable() ? "disabled" : "" %>>Add to Cart</button>
                    <button type="button" class="qty-btn clear">Clear</button>
                </div>

                <input type="hidden" class="menu-id" value="<%= m.getMenuId() %>">
            </div>
        </div>
        <% } %>
    <% } else { %>
        <p class="no-menu-items">No menu items available.</p>
    <% } %>
</div>

<!-- Toast -->
<div id="toast"></div>

<!-- FOOTER -->
<footer>
    <div class="container">
        <p>© 2025 FoodHub | All Rights Reserved</p>
    </div>
</footer>

<!-- JS for Cart -->
<script>
const isLoggedIn = <%= (userId != null) ? "true" : "false" %>;
const contextPath = "<%=request.getContextPath()%>";

function showToast(message){
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'),2000);
}

function getMenuId(item){
    const menuInput = item.querySelector(".menu-id");
    return menuInput ? parseInt(menuInput.value || "0") : 0;
}

function addToCart(menuId, quantity, action){
    if(!isLoggedIn){ window.location.href="login.jsp"; return; }
    if(menuId<=0){ showToast("Invalid menu item"); return; }
    const body="action="+encodeURIComponent(action)+"&menuId="+encodeURIComponent(menuId)+"&quantity="+encodeURIComponent(quantity);
    fetch(contextPath+"/cart",{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded"},
        body:body
    }).then(res=>res.json()).then(data=>{
        if(data.status==="success"){ showToast("Cart updated"); updateCartBadge(data.count); }
        else showToast(data.message || "Failed to update cart");
    }).catch(err=>{ console.error(err); showToast("Network error"); });
}

function updateCartBadge(count){
    const badge = document.querySelector(".cart-badge");
    if(badge) badge.textContent = count!==undefined ? count : (parseInt(badge.textContent)||0);
}

document.addEventListener('DOMContentLoaded',function(){
    document.querySelectorAll(".menu-item-wrapper").forEach(item=>{
        const decrease=item.querySelector(".decrease");
        const increase=item.querySelector(".increase");
        const clearBtn=item.querySelector(".clear");
        const addBtn=item.querySelector(".btn-add");
        const input=item.querySelector(".quantity-input-display");

        decrease?.addEventListener('click',e=>{e.preventDefault();let val=parseInt(input.value||"0"); if(val>0) input.value=val-1;});
        increase?.addEventListener('click',e=>{e.preventDefault(); let val=parseInt(input.value||"0"); input.value=val+1; });
        clearBtn?.addEventListener('click',e=>{e.preventDefault(); input.value=0; const menuId=getMenuId(item); if(menuId>0) addToCart(menuId,0,"remove");});
        addBtn?.addEventListener('click',e=>{e.preventDefault(); const menuId=getMenuId(item); const qty=parseInt(input.value||"0"); if(qty>0) addToCart(menuId,qty,"add"); else addToCart(menuId,0,"remove");});
    });
    updateCartBadge();
});
</script>

</body>
</html>
