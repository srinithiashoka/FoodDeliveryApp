<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.util.List" %>
<%@ page import="com.foodapp.model.CartItem" %>
<%@ page import="com.foodapp.dao.impl.CartDAOImpl" %>
<%@ page import="com.foodapp.dao.impl.MenuDAOImpl" %>
<%@ page import="com.foodapp.model.Menu" %>
<%@ page import="com.foodapp.model.User" %>

<%
    User user = (User) session.getAttribute("user");
    Integer userId = (user != null) ? user.getUserId() : null;
    CartDAOImpl cartDAO = new CartDAOImpl();
    MenuDAOImpl menuDAO = new MenuDAOImpl();
    List<CartItem> cartItems = cartDAO.getCartByUser(userId != null ? userId : 0);
%>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Your Cart - FoodHub</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<style>
@charset "UTF-8";

/* =======================
   General Styles
======================= */
body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f9f9f9; }
.container { width:90%; max-width:1200px; margin:0 auto; }

/* =======================
   Header & Navbar
======================= */
header { background:#fff; box-shadow:0 2px 6px rgba(0,0,0,0.1); padding:10px 0; position:sticky; top:0; z-index:1000; }
.navbar { display:flex; align-items:center; justify-content:space-between; }
.logo { font-size:1.5rem; font-weight:bold; color:#ff4757; display:flex; align-items:center; }
.scooter-icon { margin-right:8px; color:#2ed573; }
.nav-menu { list-style:none; display:flex; gap:15px; margin:0; padding:0; }
.nav-menu li a { color:#333; text-decoration:none; font-weight:500; }
.nav-actions { display:flex; align-items:center; gap:10px; }
.btn-login, .btn-signup { padding:6px 12px; border:none; border-radius:5px; cursor:pointer; }
.btn-login { background:#2ed573; color:#fff; }
.btn-signup { background:#ff4757; color:#fff; }
.cart-icon-wrapper { position:relative; display:inline-block; }
.cart-icon-wrapper img { width:34px; height:34px; cursor:pointer; }
.cart-badge { position:absolute; top:-6px; right:-6px; background:#ff4757; color:white; font-size:12px; font-weight:bold; padding:2px 7px; border-radius:50%; }

/* =======================
   Cart Cards
======================= */
.menu-container { padding:50px 0; max-width:900px; margin:0 auto; }
.cart-card { display:flex; background:#fff; margin-bottom:15px; border-radius:10px; box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow:hidden; }
.cart-image { width:120px; height:100px; flex-shrink:0; }
.cart-image img { width:100%; height:100%; object-fit:cover; }
.cart-content { flex:1; padding:10px 15px; display:flex; flex-direction:column; justify-content:space-between; }
.cart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:5px; }
.cart-header h4 { margin:0; color:#ff4757; font-size:1rem; }
.cart-header span { font-weight:bold; }
.cart-description { font-size:0.9rem; color:#555; margin-bottom:8px; }
.quantity-controls { display:flex; gap:6px; align-items:center; margin-bottom:8px; }
.quantity-input-display { width:35px; height:30px; text-align:center; border-radius:5px; border:1px solid #ccc; background:#f7f7f7; font-size:0.9rem; flex-shrink:0; }
.qty-btn { border:none; background:#ddd; padding:4px 8px; border-radius:5px; cursor:pointer; font-weight:bold; display:flex; align-items:center; justify-content:center; }
.qty-btn:hover { background:#bbb; }
.qty-btn.clear { background:#ff6b81; color:white; padding:0 10px; }
.btn-remove { background:#ff4757; color:#fff; border:none; border-radius:5px; padding:4px 8px; cursor:pointer; align-self:flex-start; }
.item-total { font-weight:bold; margin-bottom:5px; }

/* Total & Clear */
#total-amount { font-weight:bold; margin-top:10px; font-size:18px; text-align:right; }
#clear-cart { margin-top:10px; padding:8px 12px; background:#ff4757; color:#fff; border:none; border-radius:4px; cursor:pointer; }

/* Toast */
#toast { visibility:hidden; min-width:150px; max-width:220px; background-color:#2ed573; color:white; text-align:center; border-radius:8px; padding:12px 12px; position:fixed; z-index:9999; top:20px; right:20px; font-size:14px; opacity:0; transition:opacity 0.3s, visibility 0.3s; box-shadow:0 2px 6px rgba(0,0,0,0.2); }
#toast.show { visibility:visible; opacity:1; }

/* Responsive */
@media(max-width:767px) { .cart-card { flex-direction:column; } .cart-image { width:100%; height:180px; } }
</style>
</head>
<body>

<!-- HEADER -->
<header>
<div class="container">
    <div class="navbar">
        <div class="logo"><i class="fa-solid fa-motorcycle scooter-icon"></i>FoodHub</div>
        <ul class="nav-menu">
            <li><a href="home.jsp">Home</a></li>
            <li><a href="#">Restaurants</a></li>
            <li><a href="#">Offers</a></li>
            <li><a href="#">Contact</a></li>
        </ul>
        <div class="nav-actions">
            <% if(user==null) { %>
                <button class="btn-login" onclick="location.href='login.jsp'">Login</button>
                <button class="btn-signup" onclick="location.href='signup.jsp'">Sign Up</button>
            <% } else { %>
                <span>Welcome, <%= user.getUsername() %></span>
            <% } %>
            <div class="cart-icon-wrapper">
                <a href="cart.jsp"><img src="https://cdn-icons-png.flaticon.com/512/3144/3144456.png" alt="Cart"></a>
                <span class="cart-badge" id="cart-count"><%= cartItems.size() %></span>
            </div>
        </div>
    </div>
</div>
</header>

<div class="container menu-container">

<% if(cartItems.isEmpty()) { %>
    <p>No items in cart</p>
<% } else { %>
    <% for(CartItem item: cartItems) { 
        Menu menu = menuDAO.getMenuItemById(item.getMenuId());
    %>
    <div class="cart-card" data-menuid="<%= item.getMenuId() %>">
        <div class="cart-image">
            <img src="<%= (menu!=null && menu.getImagePath()!=null && !menu.getImagePath().isEmpty()) ? menu.getImagePath() : "images/restaurants/" + menu.getRestaurantId() + "/" + menu.getMenuId() + ".jpg" %>" alt="<%= item.getFoodName() %>">
        </div>
        <div class="cart-content">
            <div class="cart-header">
                <h4><%= item.getFoodName() %></h4>
                <span>₹<span class="price"><%= item.getPrice() %></span></span>
            </div>
            <div class="quantity-controls">
                <button class="qty-btn decrease">-</button>
                <input type="text" value="<%= item.getQuantity() %>" class="quantity-input-display" readonly>
                <button class="qty-btn increase">+</button>
                <button class="qty-btn clear">Clear</button>
            </div>
            <p class="item-total">Total: ₹<span class="total"><%= item.getPrice()*item.getQuantity() %></span></p>
            <button class="btn-remove">Remove</button>
        </div>
    </div>
    <% } %>

    <p id="total-amount">Grand Total: ₹<span id="grand-total"></span></p>
    <button id="clear-cart">Clear Cart</button>
<% } %>
</div>

<div id="toast"></div>

<!-- FOOTER -->
<footer style="text-align:center; padding:20px; background:#fff; margin-top:30px; box-shadow:0 -2px 6px rgba(0,0,0,0.05);">
<p>© 2025 FoodHub | All Rights Reserved</p>
</footer>

<script>
function showToast(msg){
    const toast=document.getElementById('toast');
    toast.textContent=msg;
    toast.classList.add('show');
    setTimeout(()=>toast.classList.remove('show'),2000);
}

function updateGrandTotal(){
    let total=0;
    document.querySelectorAll('.cart-card').forEach(card=>{
        const price=parseFloat(card.querySelector('.price').textContent);
        const qty=parseInt(card.querySelector('.quantity-input-display').value);
        card.querySelector('.total').textContent=(price*qty).toFixed(2);
        total+=price*qty;
    });
    document.getElementById('grand-total').textContent=total.toFixed(2);
}
updateGrandTotal();

function updateCart(menuId, quantityChange, action){
    let body=`action=${action}&menuId=${menuId}`;
    if(action==='add') body+=`&quantity=${quantityChange}`;
    fetch('cart',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:body
    }).then(res=>res.json()).then(data=>{
        showToast(data.message||'Updated');

        const card=document.querySelector(`.cart-card[data-menuid='${menuId}']`);
        if(!card) return;
        const qtyElem=card.querySelector('.quantity-input-display');
        let qty=parseInt(qtyElem.value);

        if(action==='add'){
            qty+=quantityChange;
            if(qty<=0) card.remove();
            else qtyElem.value=qty;
        } else if(action==='remove' || action==='clear'){
            card.remove();
        }

        if(document.querySelectorAll('.cart-card').length===0){
            document.querySelector('.menu-container').innerHTML='<p>No items in cart</p>';
        }

        updateGrandTotal();
        const badge=document.getElementById('cart-count');
        if(badge) badge.textContent=data.cartCount||0;
    }).catch(err=>console.error(err));
}

// Event listeners for cards
document.querySelectorAll('.cart-card').forEach(card=>{
    const menuId=parseInt(card.dataset.menuid);
    card.querySelector('.increase')?.addEventListener('click',()=>updateCart(menuId,1,'add'));
    card.querySelector('.decrease')?.addEventListener('click',()=>updateCart(menuId,-1,'add'));
    card.querySelector('.clear')?.addEventListener('click',()=>updateCart(menuId,0,'remove'));
    card.querySelector('.btn-remove')?.addEventListener('click',()=>updateCart(menuId,0,'remove'));
});

// Clear cart
document.getElementById('clear-cart')?.addEventListener('click',()=>{
    fetch('cart',{
        method:'POST',
        headers:{'Content-Type':'application/x-www-form-urlencoded'},
        body:'action=clear'
    }).then(res=>res.json()).then(data=>{
        showToast(data.message||'Cart cleared');
        document.querySelectorAll('.cart-card').forEach(c=>c.remove());
        document.getElementById('grand-total').textContent='0';
        document.getElementById('cart-count').textContent='0';
        document.querySelector('.menu-container').innerHTML='<p>No items in cart</p>';
    });
});
</script>

</body>
</html>
