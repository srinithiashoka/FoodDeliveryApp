<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.util.List" %>
<%@ page import="com.foodapp.model.CartItem" %>
<%@ page import="com.foodapp.dao.impl.CartDAOImpl" %>
<%@ page import="com.foodapp.model.User" %>

<%
    CartDAOImpl cartDAO = new CartDAOImpl();
    User user = (User) session.getAttribute("user");
    Integer userId = (user != null) ? user.getUserId() : 0;
    List<CartItem> cartItems = cartDAO.getCartByUser(userId);

    double subtotal = 0;
    for(CartItem item : cartItems){
        subtotal += item.getPrice() * item.getQuantity();
    }
    double tax = subtotal * 0.05;
    double discount = subtotal * 0.1;
    double grandTotal = subtotal + tax - discount;

    Integer cartCount = cartItems.size();
%>

<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FoodHub - Your Cart</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<link rel="stylesheet" href="css/home.css">
<style>
/* =======================
   CART PAGE
======================= */
.cart-container {
    max-width: 900px;
    margin: 3rem auto;
    padding: 0 1rem;
}

.cart-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    border-bottom: 1px solid #eee;
    padding: 1rem 0;
    flex-wrap: wrap;
    background: #fff;
    border-radius: 1rem;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
    margin-bottom: 1rem;
}

.cart-image {
    width: 120px;
    height: 120px;
    flex-shrink: 0;
    border-radius: 12px;
    overflow: hidden;
    margin-right: 20px;
}

.cart-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.cart-content {
    flex: 1;
}

.cart-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
}

.cart-header h3 {
    margin: 0;
    font-size: 1.2rem;
    color: #ff4757;
}

.cart-price {
    font-weight: bold;
    margin-top: 5px;
}

.quantity-controls {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    flex-wrap: wrap;
}

.quantity-input-display {
    width: 40px;
    height: 36px;
    text-align: center;
    border-radius: 5px;
    border: 1px solid #ccc;
    background: #f7f7f7;
    font-size: 0.9rem;
}

.qty-btn {
    border: none;
    background: #ddd;
    padding: 6px 10px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    font-size: 0.85rem;
}

.qty-btn:hover { background: #bbb; }

.btn-remove {
    background: #ff6b81;
    color: #fff;
    border: none;
    padding: 0 12px;
    border-radius: 5px;
    height: 36px;
    cursor: pointer;
}

.cart-summary {
    margin-top: 2rem;
    border: 1px solid #eee;
    border-radius: 12px;
    padding: 1.5rem 1.5rem;
    background: #fff;
    box-shadow: 0 10px 25px rgba(0,0,0,0.05);
}

.cart-summary h3 {
    text-align: center;
    color: #ff4757;
    margin-bottom: 1rem;
}

.cart-summary p {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-weight: 600;
}

.cart-summary .grand-total {
    font-size: 1.2rem;
    color: #ff4757;
    margin-top: 0.5rem;
}

.cart-summary button {
    width: 100%;
    padding: 0.8rem 0;
    margin-top: 1rem;
    border: none;
    border-radius: 25px;
    background: #2ed573;
    color: #fff;
    font-weight: 700;
    cursor: pointer;
}

.payment-method {
    margin-top: 1rem;
}

.payment-method label {
    display: block;
    margin-bottom: 0.5rem;
    cursor: pointer;
}

@media(max-width: 767px){
    .cart-item { flex-direction: column; align-items: flex-start; }
    .quantity-controls { margin-top: 0; }
}
</style>
</head>
<body>

<!-- HEADER -->
<jsp:include page="header.jsp"></jsp:include>

<div class="cart-container">

    <a href="restaurants.jsp" class="back-link"><i class="fa fa-arrow-left"></i> Back to Restaurants</a>

    <h2 class="menu-title">Your Cart</h2>

    <% if(cartItems.isEmpty()){ %>
        <p class="no-menu-items">Your cart is empty.</p>
    <% } else { 
        for(CartItem item : cartItems){ %>
            <div class="cart-item">
                <div class="cart-image">
                    <img src="<%= item.getFoodImage()!=null&&!item.getFoodImage().isEmpty()?item.getFoodImage():"images/restaurants/default.jpg" %>" alt="<%= item.getFoodName() %>">
                </div>
                <div class="cart-content">
                    <div class="cart-header">
                        <h3><%= item.getFoodName() %></h3>
                        <div class="cart-price">₹<%= item.getPrice() %></div>
                    </div>
                    <div class="quantity-controls">
                        <button class="qty-btn decrease">-</button>
                        <input type="text" value="<%= item.getQuantity() %>" class="quantity-input-display" readonly>
                        <button class="qty-btn increase">+</button>
                        <button class="btn-remove">Remove</button>
                    </div>
                </div>
            </div>
    <% }} %>

    <div class="cart-summary">
        <h3>Order Summary</h3>
        <p>Subtotal <span>₹<%= String.format("%.2f", subtotal) %></span></p>
        <p>Tax (5%) <span>₹<%= String.format("%.2f", tax) %></span></p>
        <p>Discount (10%) <span>-₹<%= String.format("%.2f", discount) %></span></p>
        <p class="grand-total">Grand Total <span>₹<%= String.format("%.2f", grandTotal) %></span></p>

        <div class="payment-method">
            <h4>Payment Method</h4>
            <label><input type="radio" name="payment" value="cod" checked> Cash on Delivery</label>
            <label><input type="radio" name="payment" value="card"> Credit/Debit Card</label>
            <label><input type="radio" name="payment" value="upi"> UPI</label>
        </div>

        <button>Proceed to Payment</button>
    </div>

</div>

<!-- FOOTER -->
<jsp:include page="footer.jsp"></jsp:include>

<script>
document.querySelectorAll('.cart-item').forEach(item=>{
    const qtyInput = item.querySelector('.quantity-input-display');
    const price = parseFloat(item.querySelector('.cart-price').textContent.replace('₹',''));
    
    item.querySelector('.increase').addEventListener('click', ()=>{
        qtyInput.value = parseInt(qtyInput.value)+1;
    });
    item.querySelector('.decrease').addEventListener('click', ()=>{
        if(parseInt(qtyInput.value) > 1) qtyInput.value = parseInt(qtyInput.value)-1;
    });
    item.querySelector('.btn-remove').addEventListener('click', ()=>{
        item.remove();
    });
});
</script>

</body>
</html>
