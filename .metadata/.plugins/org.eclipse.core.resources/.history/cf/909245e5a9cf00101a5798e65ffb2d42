<%@ page import="java.util.List" %>
<%@ page import="com.foodapp.model.CartItem" %>
<%@ page import="com.foodapp.dao.CartDAO" %>
<%@ page import="com.foodapp.dao.impl.CartDAOImpl" %>
<%@ page import="com.foodapp.model.User" %>

<%
User user = (User) session.getAttribute("user");
if (user == null) {
response.sendRedirect("login.jsp");
return;
}


CartDAO cartDAO = new CartDAOImpl();
List<CartItem> cartList = cartDAO.getCartByUser(user.getUserId());


%>

<!DOCTYPE html>

<html>
<head>
    <title>Your Cart - FoodHub</title>
    <style>
        table { border-collapse: collapse; width: 80%; margin-top: 20px; }
        th, td { padding: 10px; text-align: center; border: 1px solid #ccc; }
        button { padding: 5px 10px; cursor: pointer; }
        .quantity-btn { width: 25px; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 10px; position: fixed; top: 20px; right: 20px; z-index: 1000; opacity: 0; transition: opacity 0.5s, visibility 0.5s; }
        #toast.show { visibility: visible; opacity: 1; }
    </style>
</head>
<body>

<h2>Your Cart</h2>
<div id="toast"></div>

<% if (cartList.isEmpty()) { %> <h3>No items in cart</h3>
<% } else { %>

<table id="cart-table">
    <tr>
        <th>Food</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
        <th>Action</th>
    </tr>

<%
double grandTotal = 0;
for (CartItem c : cartList) {
double total = c.getPrice() * c.getQuantity();
grandTotal += total;
%> <tr data-menuid="<%= c.getMenuId() %>"> <td><%= c.getFoodName() %></td> <td> <button class="quantity-btn decrease">-</button> <span class="qty"><%= c.getQuantity() %></span> <button class="quantity-btn increase">+</button> </td> <td>₹ <%= c.getPrice() %></td> <td class="total">₹ <%= total %></td> <td><button class="remove-btn">Remove</button></td> </tr>
<% } %>

</table>

<h3 id="grand-total">Grand Total: ₹ <%= grandTotal %></h3>
<button id="clear-cart" style="margin-top:20px; background:red; color:#fff;">Clear Cart</button>

<% } %>

<script>
function showToast(msg) {
    const toast = document.getElementById("toast");
    toast.textContent = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
}

function updateCartTable(menuId, newQty, newTotal, grandTotal) {
    const row = document.querySelector(`tr[data-menuid='${menuId}']`);
    if (newQty <= 0) {
        row.remove();
    } else {
        row.querySelector(".qty").textContent = newQty;
        row.querySelector(".total").textContent = "₹ " + newTotal;
    }
    document.getElementById("grand-total").textContent = "Grand Total: ₹ " + grandTotal;
}

function sendCartUpdate(action, menuId, qty) {
    fetch("cart", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=${action}&menuId=${menuId}&quantity=${qty}`
    })
    .then(r => r.text())
    .then(res => {
        if (res.trim() === "success") {
            fetch("cart?action=viewData")
            .then(r => r.json())
            .then(data => {
                if (action === "clear") {
                    document.getElementById("cart-table").innerHTML = "<tr><th>Food</th><th>Qty</th><th>Price</th><th>Total</th><th>Action</th></tr>";
                    document.getElementById("grand-total").textContent = "Grand Total: ₹ 0";
                } else {
                    updateCartTable(menuId, data.qty, data.total, data.grandTotal);
                }
                showToast(action === "delete" || action==="clear" ? "Item removed!" : "Updated successfully!");
            });
        } else {
            alert("Cart update failed!");
        }
    });
}

document.querySelectorAll(".increase").forEach(btn => {
    btn.onclick = () => {
        const row = btn.closest("tr");
        const menuId = row.getAttribute("data-menuid");
        sendCartUpdate("add", menuId, 1);
    };
});

document.querySelectorAll(".decrease").forEach(btn => {
    btn.onclick = () => {
        const row = btn.closest("tr");
        const menuId = row.getAttribute("data-menuid");
        sendCartUpdate("add", menuId, -1);
    };
});

document.querySelectorAll(".remove-btn").forEach(btn => {
    btn.onclick = () => {
        const row = btn.closest("tr");
        const menuId = row.getAttribute("data-menuid");
        sendCartUpdate("delete", menuId, 0);
    };
});

document.getElementById("clear-cart")?.addEventListener("click", () => {
    sendCartUpdate("clear", 0, 0);
});
</script>

</body>
</html>
