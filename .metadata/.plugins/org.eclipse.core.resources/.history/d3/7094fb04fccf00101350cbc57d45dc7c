<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="com.foodapp.model.User"%>

<%
    User user = (User) session.getAttribute("user");
    Integer userId = (user != null) ? user.getUserId() : null;
%>

<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Menu - FoodHub</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/home.css">
    <link rel="stylesheet" href="css/menu.css">
    <style>
        .quantity-controls { display: flex; align-items: center; gap: 4px; margin-bottom: 10px; }
        .quantity-input-display { width: 28px; height: 26px; text-align: center; padding: 2px 4px; border-radius: 4px; border: 1px solid #ccc; background: #f7f7f7; font-size: 0.75rem; }
        .qty-btn { width: 26px; height: 26px; border: none; background: #ddd; border-radius: 4px; cursor: pointer; font-weight: bold; font-size: 0.75rem; display: flex; align-items: center; justify-content: center; }
        .qty-btn:hover { background: #bbb; }
        .btn-add { padding: 3px 6px; border: none; border-radius: 4px; background: #ff4757; color: #fff; cursor: pointer; font-size: 0.75rem; }
        .btn-add:disabled { background: #ccc; cursor: not-allowed; }
        #toast { visibility: hidden; min-width: 250px; background-color: #333; color: #fff; text-align: center; border-radius: 4px; padding: 10px; position: fixed; top: 20px; right: 20px; z-index: 1000; opacity: 0; transition: opacity 0.5s, visibility 0.5s; }
        #toast.show { visibility: visible; opacity: 1; }
        .clear-all { margin: 15px 0; padding: 6px 12px; background: #ff6b81; color: #fff; border: none; border-radius: 4px; cursor: pointer; }
        .menu-item-wrapper { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .menu-image img { width: 120px; height: 90px; object-fit: cover; border-radius: 6px; }
    </style>
</head>
<body>
<header>
    <div class="container">
        <div class="navbar">
            <div class="logo"><i class="fa-solid fa-motorcycle scooter-icon"></i> <span class="logo-text">FoodHub</span></div>
            <ul class="nav-menu">
                <li><a href="home.jsp">Home</a></li>
                <li><a href="#">Restaurants</a></li>
                <li><a href="#">Offers</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
            <div class="nav-actions">
                <% if(user == null) { %>
                    <button class="btn btn-login" onclick="location.href='login.jsp'">Login</button>
                    <button class="btn btn-signup" onclick="location.href='signup.jsp'">Sign Up</button>
                <% } else { %>
                    <span>Welcome, <%= user.getUsername() %></span>
                <% } %>
                <div class="cart-icon-wrapper">
                    <a href="cart.jsp"><img src="https://cdn-icons-png.flaticon.com/512/3144/3144456.png" alt="Cart"></a>
                    <span class="cart-badge"><%= session.getAttribute("cartCount") != null ? session.getAttribute("cartCount") : 0 %></span>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="container menu-container">
    <a href="home.jsp" class="back-link"><i class="fa fa-arrow-left"></i> Back to Restaurants</a>
    <h1 style="text-align:center; margin-bottom:20px; color:#ff4757;">Menu</h1>

    <button class="clear-all" onclick="clearEntireCart()">Clear All Items</button>
    <div id="menu-items"></div>
</div>

<div id="toast"></div>
<footer><p>Â© 2025 FoodHub | All Rights Reserved</p></footer>

<script>
const isLoggedIn = <%= (userId != null) ? "true" : "false" %>;

// Show toast
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2500);
}

// Update cart badge
function updateCartBadge() {
    fetch("<%=request.getContextPath()%>/cart?action=viewcount")
        .then(res => res.json())
        .then(data => document.querySelector(".cart-badge").textContent = data.count || 0)
        .catch(err => console.error(err));
}

// Add to cart
function addToCart(menuId, quantity, action) {
    if (!isLoggedIn) {
        window.location.href = "<%=request.getContextPath()%>/login.jsp";
        return;
    }
    fetch("<%=request.getContextPath()%>/cart", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=${action}&menuId=${menuId}&quantity=${quantity}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            showToast(data.message);
            updateCartBadge();
        } else alert(data.message || "Cart update failed!");
    });
}

// Clear entire cart
function clearEntireCart() {
    if (!isLoggedIn) {
        window.location.href = "<%=request.getContextPath()%>/login.jsp";
        return;
    }
    fetch("<%=request.getContextPath()%>/cart", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=clear`
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            showToast(data.message);
            document.querySelectorAll(".quantity-input-display").forEach(inp => inp.value = 0);
            updateCartBadge();
        } else alert(data.message || "Failed to clear cart!");
    });
}

// Fetch menu items by restaurantId dynamically
function loadMenu(restaurantId) {
    fetch(`<%=request.getContextPath()%>/menu?action=byrestaurant&restaurantId=${restaurantId}`)
        .then(res => res.text())
        .then(html => {
            // Replace menu-items container with server-rendered HTML
            document.getElementById("menu-items").innerHTML = html;

            // Attach event listeners for newly loaded menu items
            document.querySelectorAll(".menu-item-wrapper").forEach(item => {
                const decrease = item.querySelector(".decrease");
                const increase = item.querySelector(".increase");
                const clearBtn = item.querySelector(".clear");
                const addBtn = item.querySelector(".btn-add");
                const input = item.querySelector(".quantity-input-display");
                const menuInput = item.querySelector(".menu-id");

                const menuId = parseInt(menuInput.value);

                decrease.onclick = () => { let val = parseInt(input.value) || 0; if(val>0) input.value = val-1; };
                increase.onclick = () => { let val = parseInt(input.value) || 0; input.value = val+1; };
                clearBtn.onclick = () => { input.value=0; addToCart(menuId, 0, "remove"); };
                addBtn.onclick = () => { let qty=parseInt(input.value)||0; if(qty>0) addToCart(menuId, qty, "add"); };
            });
        });
}

// Example: load menu for restaurantId=1 initially
window.onload = function() {
    loadMenu(1);
    updateCartBadge();
};
</script>
</body>
</html>
