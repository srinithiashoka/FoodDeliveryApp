package com.foodapp.dao.impl;

import com.foodapp.dao.CartDAO;
import com.foodapp.model.Cart;
import com.foodapp.model.CartItem;
import com.foodapp.util.DBConnection;

import java.sql.*;
import java.util.*;

public class CartDAOImpl implements CartDAO {

    @Override
    public boolean addToCart(Cart c) {
        String sql = "INSERT INTO cart (userId, menuId, quantity) VALUES (?, ?, ?)";

        try (Connection conn = DBConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setInt(1, c.getUserId());
            ps.setInt(2, c.getMenuId());
            ps.setInt(3, c.getQuantity());

            return ps.executeUpdate() > 0;

        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }


    @Override
    public List<CartItem> getCartByUser(int userId) {

        List<CartItem> list = new ArrayList<>();

        String sql = """
            SELECT c.cartId, c.menuId, c.quantity,
                   m.foodName, m.image, m.price
            FROM cart c
            JOIN menu m ON c.menuId = m.menuId
            WHERE c.userId = ?
        """;

        try (Connection conn = DBConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setInt(1, userId);
            ResultSet rs = ps.executeQuery();

            while (rs.next()) {

                CartItem item = new CartItem();
                item.setCartId(rs.getInt("cartId"));
                item.setMenuId(rs.getInt("menuId"));
                item.setQuantity(rs.getInt("quantity"));
                item.setFoodName(rs.getString("foodName"));
                item.setFoodImage(rs.getString("image"));
                item.setPrice(rs.getDouble("price"));

                list.add(item);
            }

        } catch (Exception e) {
            e.printStackTrace();
        }

        return list;
    }


    @Override
    public boolean updateCart(Cart c) {
        String sql = "UPDATE cart SET quantity=? WHERE cartId=?";

        try (Connection conn = DBConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setInt(1, c.getQuantity());
            ps.setInt(2, c.getCartId());

            return ps.executeUpdate() > 0;

        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }


    @Override
    public boolean deleteCartItem(int cartId) {
        String sql = "DELETE FROM cart WHERE cartId=?";

        try (Connection conn = DBConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setInt(1, cartId);
            return ps.executeUpdate() > 0;

        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }


    @Override
    public boolean clearCart(int userId) {
        String sql = "DELETE FROM cart WHERE userId=?";

        try (Connection conn = DBConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setInt(1, userId);
            return ps.executeUpdate() > 0;

        } catch (Exception e) {
            e.printStackTrace();
        }
        return false;
    }


    @Override
    public int getCartCount(int userId) {
        String sql = "SELECT COUNT(*) FROM cart WHERE userId=?";

        try (Connection conn = DBConnection.getConnection();
             PreparedStatement ps = conn.prepareStatement(sql)) {

            ps.setInt(1, userId);
            ResultSet rs = ps.executeQuery();
            rs.next();
            return rs.getInt(1);

        } catch (Exception e) {
            e.printStackTrace();
        }
        return 0;
    }
}
