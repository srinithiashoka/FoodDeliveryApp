<%@ page import="java.util.List" %>
<%@ page import="com.foodapp.model.CartItem" %>
<%@ page import="com.foodapp.dao.CartDAO" %>
<%@ page import="com.foodapp.dao.impl.CartDAOImpl" %>
<%@ page import="com.foodapp.model.User" %>

<%
    User user = (User) session.getAttribute("user");
    if (user == null) {
        response.sendRedirect("login.jsp");
        return;
    }

    CartDAO cartDAO = new CartDAOImpl();
    List<CartItem> cartList = cartDAO.getCartByUser(user.getUserId());
%>

<!DOCTYPE html>
<html>
<head>
    <title>Your Cart - FoodHub</title>
    <style>
        table {
            border-collapse: collapse;
            width: 80%;
            margin-top: 20px;
        }
        th, td {
            padding: 10px;
            text-align: center;
            border: 1px solid #ccc;
        }
        button {
            padding: 5px 10px;
            cursor: pointer;
        }
        .quantity-btn { width: 25px; }

        /* Same tiny toast style, no black box */
        #toast {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;

            background: transparent;
            color: #333;
            padding: 0;
            margin: 0;
            font-size: 14px;

            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s, visibility 0.2s;

            display: inline-block;
        }
        #toast.show {
            visibility: visible;
            opacity: 1;
        }
    </style>
</head>
<body>

<h2>Your Cart</h2>

<% if (cartList.isEmpty()) { %>
    <h3>No items in cart</h3>
<% } else { %>

<table>
    <tr>
        <th>Food</th>
        <th>Qty</th>
        <th>Price</th>
        <th>Total</th>
        <th>Action</th>
    </tr>

<%
    double grandTotal = 0;
    for (CartItem c : cartList) {
        double total = c.getPrice() * c.getQuantity();
        grandTotal += total;
%>
    <tr data-menuid="<%= c.getMenuId() %>">
        <td><%= c.getFoodName() %></td>
        <td>
            <button class="quantity-btn decrease">-</button>
            <span class="qty"><%= c.getQuantity() %></span>
            <button class="quantity-btn increase">+</button>
        </td>
        <td>₹ <%= c.getPrice() %></td>
        <td class="total">₹ <%= total %></td>
        <td><button class="remove-btn">Remove</button></td>
    </tr>
<% } %>
</table>

<h3 id="grand-total">Grand Total: ₹ <%= grandTotal %></h3>
<button id="clear-cart" style="margin-top:20px; background:red; color:#fff;">Clear Cart</button>
<% } %>

<div id="toast"></div>

<script>
function showToast(message) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.classList.add('show');
    setTimeout(() => toast.classList.remove('show'), 2000);
}

function updateCart(menuId, quantity, action) {
    if (menuId <= 0 || quantity < 0) {
        showToast("Invalid menuId or quantity");
        console.error("Invalid params:", { menuId, quantity, action });
        return;
    }

    fetch("cart", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: `action=${encodeURIComponent(action)}&menuId=${encodeURIComponent(menuId)}&quantity=${encodeURIComponent(quantity)}`
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") {
            showToast("Cart updated successfully");
        } else {
            showToast(data.message || "Cart update failed");
        }
        location.reload();
    })
    .catch(err => {
        console.error("Fetch error:", err);
        showToast("Network error occurred");
    });
}

document.querySelectorAll('.increase').forEach(btn => {
    btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        const menuId = parseInt(tr.dataset.menuid?.trim() || "0", 10);
        const qtyElem = tr.querySelector('.qty');
        let qty = parseInt(qtyElem?.textContent?.trim() || "0", 10) + 1;
        updateCart(menuId, qty, "add");
    });
});

document.querySelectorAll('.decrease').forEach(btn => {
    btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        const menuId = parseInt(tr.dataset.menuid?.trim() || "0", 10);
        const qtyElem = tr.querySelector('.qty');
        let qty = parseInt(qtyElem?.textContent?.trim() || "0", 10) - 1;
        updateCart(menuId, qty, qty <= 0 ? "remove" : "add");
    });
});

document.querySelectorAll('.remove-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const tr = btn.closest('tr');
        const menuId = parseInt(tr.dataset.menuid?.trim() || "0", 10);
        updateCart(menuId, 0, "remove");
    });
});

document.getElementById('clear-cart')?.addEventListener('click', () => {
    fetch("cart", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "action=clear"
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "success") showToast("Cart cleared successfully");
        location.reload();
    })
    .catch(err => console.error(err));
});
</script>

</body>
</html>
