<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.util.List" %>
<%@ page import="com.foodapp.dao.RestaurantDAO" %>
<%@ page import="com.foodapp.dao.impl.RestaurantDAOImpl" %>
<%@ page import="com.foodapp.model.Restaurant" %>
<%@ page import="com.foodapp.model.User" %>

<%
    String location = request.getParameter("location");
    String restaurantName = request.getParameter("restaurant");
    boolean isSearchActive = (location != null && !location.trim().isEmpty()) || (restaurantName != null && !restaurantName.trim().isEmpty());

    RestaurantDAO dao = new RestaurantDAOImpl();
    List<Restaurant> restaurants;

    if (isSearchActive) {
        restaurants = dao.searchRestaurants(location, restaurantName);
    } else {
        restaurants = dao.getActiveRestaurants();
    }

    User user = (User) session.getAttribute("user");
    Integer cartCount = (Integer) session.getAttribute("cartCount");
    if (cartCount == null) cartCount = 0;
%>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FoodHub - Food Delivery App | Coimbatore</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="stylesheet" href="css/home.css">
</head>

<body>
<!-- NAVBAR -->
<header>
    <div class="container">
        <div class="navbar">
            <div class="logo">
                <i class="fa-solid fa-motorcycle scooter-icon"></i>
                <span class="logo-text">FoodHub</span>
            </div>

            <ul class="nav-menu">
                <li><a href="home.jsp">Home</a></li>
                <li><a href="#">Restaurants</a></li>
                <li><a href="#">Offers</a></li>
                <li><a href="#">Contact</a></li>
            </ul>

            <div class="nav-actions">
                <% if (user == null) { %>
                    <button class="btn btn-login" onclick="location.href='login.jsp'">Login</button>
                    <button class="btn btn-signup" onclick="location.href='signup.jsp'">Sign Up</button>
                <% } else { %>
                    <span class="welcome-text">Welcome, <%= user.getUsername() %></span>
                <% } %>
                <div class="cart-icon-wrapper">
                    <a href="cart.jsp" title="View Cart ( <%= cartCount %> items )">
                        <i class="fas fa-shopping-cart cart-icon"></i>
                    </a>
                    <% if (cartCount > 0) { %>
                        <span class="cart-badge"><%= cartCount %></span>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- HERO SECTION -->
<section class="hero">
    <div class="container">
        <div class="hero-content">
            <div class="hero-text">
                <h1>Order food from your favourite restaurants near you</h1>
                <p>Get your food delivered fast • Fresh & Hot • Track Live</p>
            </div>
            
            <!-- FIXED SEARCH BOX - STRAIGHT LINE -->
            <div class="search-box">
                <form action="home.jsp" method="get" class="search-form">
                    <div class="input-wrapper location-input">
                        <i class="fa fa-map-marker-alt"></i>
                        <input type="text" name="location" placeholder="Enter your location (e.g., Coimbatore)"
                               value="<%= location != null ? location : "" %>">
                    </div>
                    <div class="input-wrapper restaurant-input">
                        <input type="text" name="restaurant" placeholder="Search restaurants (e.g., Domino's)"
                               value="<%= restaurantName != null ? restaurantName : "" %>">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        <i class="fa fa-search"></i> Find Food
                    </button>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- CATEGORIES SECTION -->
<section class="categories">
    <div class="container">
        <h2>Popular Categories</h2>
        <div class="category-grid">
            <a href="home.jsp?restaurant=pizza" class="category-card">
                <div class="category-image">
                    <img src="images/pizzas.jpg" alt="Pizza" loading="lazy">
                </div>
                <p>Pizza</p>
            </a>
            <a href="home.jsp?restaurant=biryani" class="category-card">
                <div class="category-image">
                    <img src="images/briyani.jpeg" alt="Biryani" loading="lazy">
                </div>
                <p>Biryani</p>
            </a>
            <a href="home.jsp?restaurant=burger" class="category-card">
                <div class="category-image">
                    <img src="images/burgers.jpg" alt="Burgers" loading="lazy">
                </div>
                <p>Burgers</p>
            </a>
            <a href="home.jsp?restaurant=cake" class="category-card">
                <div class="category-image">
                    <img src="images/cake.jpg" alt="Cakes" loading="lazy">
                </div>
                <p>Cakes</p>
            </a>
            <a href="home.jsp?location=coimbatore" class="category-card">
                <div class="category-image">
                    <img src="images/meals.jpeg" alt="Meals" loading="lazy">
                </div>
                <p>Meals</p>
            </a>
        </div>
    </div>
</section>

<!-- RESTAURANTS SECTION -->
<section class="restaurants">
    <div class="container">
        <h2>
            <% if (location != null && !location.isEmpty()) { %>
                Restaurants in <%= location %>
            <% } else if (restaurantName != null && !restaurantName.isEmpty()) { %>
                Search Results for "<%= restaurantName %>"
            <% } else { %>
                Top Restaurants Near You
            <% } %>
        </h2>
        
        <% if (isSearchActive && restaurants != null && !restaurants.isEmpty()) { %>
            <div class="search-results-info">
                <span><i class="fas fa-check-circle"></i>Found <%= restaurants.size() %> restaurant<%= restaurants.size() != 1 ? "s" : "" %></span>
            </div>
        <% } %>

        <div class="restaurant-grid">
            <% if (restaurants != null && !restaurants.isEmpty()) {
                for (Restaurant r : restaurants) { %>
            <a href="menu?action=byRestaurant&restaurantId=<%= r.getRestaurantId() %>" class="restaurant-card-link">
                <div class="restaurant-card">
                    <% String imgPath = r.getImagePath();
                       if (imgPath == null || imgPath.isEmpty()) {
                           imgPath = "images/restaurants/default.jpg";
                       } %>
                    <div class="restaurant-image">
                        <img src="<%= imgPath %>" alt="<%= r.getName() %>" loading="lazy"
                             onerror="this.src='images/restaurants/default.jpg'">
                    </div>
                    <div class="restaurant-info">
                        <h3><%= r.getName() %></h3>
                        <div class="restaurant-meta">
                            <span class="cuisine"><%= r.getCuisineType() %></span>
                            <span class="delivery-time"><%= r.getDeliveryTime() %></span>
                        </div>
                        <p class="address">
                            <%= r.getAddress().length() > 50 ? r.getAddress().substring(0, 50) + "..." : r.getAddress() %>
                        </p>
                        <div class="restaurant-rating">
                            <span class="rating">★★★★☆ 4.5</span>
                            <span class="orders">124 orders</span>
                        </div>
                    </div>
                </div>
            </a>
            <%  }
            } else { %>
                <div class="no-results">
                    <i class="fa fa-search"></i>
                    <h3>No restaurants found</h3>
                    <p>Try adjusting your search terms or location. Popular options:</p>
                    <div class="quick-links">
                        <a href="home.jsp?location=coimbatore">Coimbatore</a>
                        <a href="home.jsp?restaurant=pizza">Pizza</a>
                        <a href="home.jsp">All Restaurants</a>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
</section>

<!-- FOOTER -->
<footer>
    <div class="container">
        <p>© 2025 FoodHub | All Rights Reserved | Made with ❤️ in Coimbatore</p>
    </div>
</footer>

<script>
const isLoggedIn = <%= (user != null) ? "true" : "false" %>;
const contextPath = "<%=request.getContextPath()%>";
const initialCartCount = <%= cartCount %>;

function updateCartBadge(count) {
    const badge = document.querySelector(".cart-badge");
    const cartLink = document.querySelector(".cart-icon-wrapper a");
    
    if (count !== undefined) {
        if (count > 0) {
            if (!badge) {
                const newBadge = document.createElement('span');
                newBadge.className = 'cart-badge';
                newBadge.textContent = count;
                document.querySelector(".cart-icon-wrapper").appendChild(newBadge);
            } else {
                badge.textContent = count;
            }
            cartLink.title = `View Cart (${count} items)`;
        } else {
            if (badge) badge.remove();
            cartLink.title = 'View Cart (0 items)';
        }
    }
}

document.addEventListener('DOMContentLoaded', function() {
    updateCartBadge(initialCartCount);
    setInterval(() => updateCartBadge(), 30000);
    
    const searchForm = document.querySelector('.search-form');
    if (searchForm) {
        searchForm.addEventListener('submit', function(e) {
            const location = this.querySelector('input[name="location"]').value.trim();
            const restaurant = this.querySelector('input[name="restaurant"]').value.trim();
            if (!location && !restaurant) {
                e.preventDefault();
                alert('Please enter location or restaurant name');
            }
        });
    }
});
</script>
</body>
</html>
