<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="java.util.List" %>
<%@ page import="com.foodapp.model.CartItem" %>
<%@ page import="com.foodapp.dao.impl.CartDAOImpl" %>
<%
    com.foodapp.dao.impl.CartDAOImpl cartDAO = new CartDAOImpl();
    Integer userId = (Integer) session.getAttribute("userId"); // Adjust if using User object
    List<CartItem> cartItems = cartDAO.getCartByUser(userId != null ? userId : 0);
%>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Your Cart</title>
<style>
table { width: 100%; border-collapse: collapse; margin-top: 20px; }
th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
button { padding: 4px 8px; cursor: pointer; }
#total-amount { font-weight: bold; margin-top: 10px; }
</style>
</head>
<body>

<h2>Your Cart</h2>

<% if (cartItems.isEmpty()) { %>
    <p>No items in cart</p>
<% } else { %>
    <table>
        <thead>
            <tr>
                <th>Item</th>
                <th>Price</th>
                <th>Quantity</th>
                <th>Total</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="cart-body">
            <% for (CartItem item : cartItems) { %>
            <tr data-menuid="<%= item.getMenuId() %>">
                <td><%= item.getFoodName() %></td>
                <td>₹<span class="price"><%= item.getPrice() %></span></td>
                <td class="qty"><%= item.getQuantity() %></td>
                <td>₹<span class="total"><%= item.getPrice() * item.getQuantity() %></span></td>
                <td>
                    <button class="increase">+</button>
                    <button class="decrease">-</button>
                    <button class="remove-btn">Remove</button>
                </td>
            </tr>
            <% } %>
        </tbody>
    </table>

    <p id="total-amount">Total Amount: ₹<span id="grand-total"></span></p>
    <button id="clear-cart">Clear Cart</button>
<% } %>

<!-- Optional toast for messages -->
<div id="toast" style="position:fixed;bottom:10px;right:10px;background:#333;color:#fff;padding:10px;border-radius:5px;display:none;"></div>

<script>
function showToast(msg) {
    const toast = document.getElementById('toast');
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(() => toast.style.display = 'none', 2000);
}

function updateGrandTotal() {
    let total = 0;
    document.querySelectorAll('#cart-body tr').forEach(row => {
        const price = parseFloat(row.querySelector('.price').textContent);
        const qty = parseInt(row.querySelector('.qty').textContent);
        row.querySelector('.total').textContent = (price * qty).toFixed(2);
        total += price * qty;
    });
    document.getElementById('grand-total').textContent = total.toFixed(2);
}

// Call initially
updateGrandTotal();

function updateCart(menuId, quantityChange, action) {
    let body = `action=${action}&menuId=${menuId}`;
    if (action === "add") body += `&quantity=${quantityChange}`;

    fetch("cart", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: body
    })
    .then(res => res.json())
    .then(data => {
        showToast(data.message || "Updated");

        // Update cart icon if exists
        const cartCountElem = document.getElementById('cart-count');
        if (cartCountElem && data.cartCount !== undefined) {
            cartCountElem.textContent = data.cartCount;
        }

        // Update table dynamically
        const row = document.querySelector(`#cart-body tr[data-menuid='${menuId}']`);
        if (!row) return;

        let qtyElem = row.querySelector('.qty');
        let qty = parseInt(qtyElem.textContent);

        if (action === "add") {
            qty += quantityChange;
            if (qty <= 0) row.remove();
            else qtyElem.textContent = qty;
        } else if (action === "remove") {
            row.remove();
        }

        // If cart is empty
        if (document.querySelectorAll('#cart-body tr').length === 0) {
            document.body.innerHTML += '<p>No items in cart</p>';
        }

        updateGrandTotal();
    })
    .catch(err => console.error(err));
}

// Event delegation for buttons
document.getElementById('cart-body').addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if (!tr) return;
    const menuId = parseInt(tr.dataset.menuid);

    if (e.target.classList.contains('increase')) updateCart(menuId, 1, 'add');
    if (e.target.classList.contains('decrease')) updateCart(menuId, -1, 'add');
    if (e.target.classList.contains('remove-btn')) updateCart(menuId, 0, 'remove');
});

// Clear cart button
document.getElementById('clear-cart')?.addEventListener('click', () => {
    fetch("cart", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: "action=clear"
    })
    .then(res => res.json())
    .then(data => {
        showToast(data.message || "Cart cleared");
        const cartCountElem = document.getElementById('cart-count');
        if (cartCountElem) cartCountElem.textContent = 0;
        document.getElementById('cart-body').innerHTML = '';
        document.getElementById('grand-total').textContent = '0';
    });
});
</script>

</body>
</html>
