<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="com.foodapp.dao.impl.OrderDAOImpl"%>
<%@ page import="com.foodapp.model.Order"%>
<%@ page import="com.foodapp.model.User"%>

<%
    // Get logged-in user from session
    User user = (User) session.getAttribute("user");

    Order order = null;
    OrderDAOImpl orderDAO = new OrderDAOImpl();

    // Check if orderId is passed as query param
    String orderParam = request.getParameter("orderId");
    if(orderParam != null && !orderParam.isEmpty()){
        try {
            int orderId = Integer.parseInt(orderParam);
            order = orderDAO.getOrderById(orderId);
        } catch(NumberFormatException e) {
            order = null;
        }
    } else if(user != null) {
        // Get last order of logged-in user
        order = orderDAO.getLastOrderByUserId(user.getUserId()); // implement this in DAO
    }
%>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Track Order - FoodHub</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Font Awesome -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
/* ===== Reset & General ===== */
* {margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",Tahoma,Geneva,Verdana,sans-serif;}
body {display:flex;flex-direction:column;min-height:100vh;background:#f9f9f9;color:#333;}
.container {width:90%;max-width:1200px;margin:auto;}

/* Header */
header {background:#ff4757;padding:12px 0;color:white;position:sticky;top:0;z-index:100;box-shadow:0 2px 5px rgba(0,0,0,0.1);}
.navbar {display:flex;justify-content:space-between;align-items:center;}
.logo {display:flex;align-items:center;gap:8px;font-weight:700;}
.nav-menu {display:flex;list-style:none;gap:20px;}
.nav-menu li a {font-weight:bold;color:white;transition:color 0.3s;}
.nav-menu li a:hover {color:#ffeaa7;}
.nav-actions {display:flex;align-items:center;gap:12px;}
.btn {padding:8px 16px;border:none;border-radius:5px;cursor:pointer;font-weight:bold;transition:background 0.3s;}
.btn-login, .btn-signup {background:#2ed573;color:white;}
.btn-login:hover, .btn-signup:hover {background:#26c35e;transform:scale(1.05);}
.cart-badge {position:absolute;top:-5px;right:-7px;background:#ff4757;color:white;font-size:12px;padding:2px 6px;border-radius:50%;}

/* Order Container */
.order-container {background:#fff;padding:20px;margin:30px auto;border-radius:12px;box-shadow:0 2px 8px rgba(0,0,0,0.1);width:90%;max-width:600px;}
.order-row {display:flex;justify-content:space-between;margin:10px 0;font-size:1rem;}
.order-status {font-weight:bold;color:#2ed573;}
.btn-back {margin-top:20px;padding:10px 18px;background:#ff4757;color:white;border:none;border-radius:5px;cursor:pointer;font-weight:bold;transition:background 0.3s;}
.btn-back:hover {background:#ff6b81;}

/* Toast */
#toast {visibility:hidden;min-width:180px;max-width:300px;background-color:#2ed573;color:white;text-align:center;border-radius:8px;padding:12px 16px;position:fixed;z-index:9999;top:20px;right:20px;font-size:14px;opacity:0;transition:opacity 0.3s, visibility 0.3s;box-shadow:0 2px 6px rgba(0,0,0,0.2);}
#toast.show {visibility:visible;opacity:1;}

/* Footer */
footer {background:#2f3542;color:white;text-align:center;padding:20px 0;font-size:0.85rem;margin-top:auto;}
</style>
</head>
<body>

<!-- HEADER -->
<header>
    <div class="container">
        <div class="navbar">
            <div class="logo"><i class="fa-solid fa-motorcycle"></i> FoodHub</div>
            <ul class="nav-menu">
                <li><a href="home.jsp">Home</a></li>
                <li><a href="#">Restaurants</a></li>
                <li><a href="#">Offers</a></li>
                <li><a href="#">Contact</a></li>
            </ul>
            <div class="nav-actions">
                <% if(user == null){ %>
                    <button class="btn btn-login" onclick="location.href='login.jsp'">Login</button>
                    <button class="btn btn-signup" onclick="location.href='signup.jsp'">Sign Up</button>
                <% } else { %>
                    <span>Welcome, <%= user.getUsername() %></span>
                <% } %>
            </div>
        </div>
    </div>
</header>

<!-- Toast -->
<div id="toast"></div>

<!-- ORDER TRACKING -->
<div class="container order-container">
    <h1>Track Your Order</h1>
    <% if(order != null){ %>
        <div class="order-row">
            <span>Order ID:</span> <span>#<%= order.getOrderId() %></span>
        </div>
        <div class="order-row">
            <span>Restaurant ID:</span> <span>#<%= order.getRestaurantId() %></span>
        </div>
        <div class="order-row">
            <span>Order Date:</span> <span><%= order.getOrderDate() %></span>
        </div>
        <div class="order-row">
            <span>Total Amount:</span> <span>₹<%= String.format("%.2f", order.getTotalAmount()) %></span>
        </div>
        <div class="order-row">
            <span>Payment Mode:</span> <span><%= order.getPaymentMode() %></span>
        </div>
        <div class="order-row">
            <span>Status:</span> <span class="order-status"><%= order.getStatus() %></span>
        </div>
        <button class="btn-back" onclick="window.location.href='home.jsp'">Back to Home</button>
    <% } else { %>
        <p style="text-align:center;color:red;">Order not found!</p>
        <button class="btn-back" onclick="window.location.href='home.jsp'">Go Home</button>
    <% } %>
</div>

<!-- FOOTER -->
<footer>
    <div class="container">
        <p>© 2025 FoodHub | All Rights Reserved</p>
    </div>
</footer>

<script>
// Show toast if order exists
<% if(order != null){ %>
    const toast = document.getElementById('toast');
    toast.innerText = "Tracking Order #<%= order.getOrderId() %>";
    toast.className = 'show';
    setTimeout(()=>{ toast.className = toast.className.replace('show',''); },3000);
<% } %>
</script>

</body>
</html>
