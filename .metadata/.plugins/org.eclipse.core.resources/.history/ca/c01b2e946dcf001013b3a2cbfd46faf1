package com.foodapp.dao.impl;

import com.foodapp.dao.CartDAO;
import com.foodapp.model.Cart;

import java.sql.*;
import java.util.ArrayList;
import java.util.List;

import com.foodapp.util.DBConnection;

public class CartDAOImpl implements CartDAO {

    @Override
    public boolean addToCart(Cart cart) {
        try(Connection con = DBConnection.getConnection()) {
            String sqlCheck = "SELECT quantity FROM cart WHERE userId=? AND menuId=?";
            PreparedStatement psCheck = con.prepareStatement(sqlCheck);
            psCheck.setInt(1, cart.getUserId());
            psCheck.setInt(2, cart.getMenuId());
            ResultSet rs = psCheck.executeQuery();
            if(rs.next()) {
                // Item exists, update quantity
                int existingQty = rs.getInt("quantity");
                String sqlUpdate = "UPDATE cart SET quantity=? WHERE userId=? AND menuId=?";
                PreparedStatement psUpdate = con.prepareStatement(sqlUpdate);
                psUpdate.setInt(1, existingQty + cart.getQuantity());
                psUpdate.setInt(2, cart.getUserId());
                psUpdate.setInt(3, cart.getMenuId());
                return psUpdate.executeUpdate() > 0;
            } else {
                // Insert new
                String sqlInsert = "INSERT INTO cart(userId, menuId, quantity) VALUES(?,?,?)";
                PreparedStatement psInsert = con.prepareStatement(sqlInsert);
                psInsert.setInt(1, cart.getUserId());
                psInsert.setInt(2, cart.getMenuId());
                psInsert.setInt(3, cart.getQuantity());
                return psInsert.executeUpdate() > 0;
            }
        } catch(Exception e) {
            e.printStackTrace();
        }
        return false;
    }

    @Override
    public boolean updateCart(Cart cart) {
        try(Connection con = DBConnection.getConnection()) {
            String sql = "UPDATE cart SET quantity=? WHERE userId=? AND menuId=?";
            PreparedStatement ps = con.prepareStatement(sql);
            ps.setInt(1, cart.getQuantity());
            ps.setInt(2, cart.getUserId());
            ps.setInt(3, cart.getMenuId());
            return ps.executeUpdate() > 0;
        } catch(Exception e) {
            e.printStackTrace();
        }
        return false;
    }

    @Override
    public boolean deleteCartItem(int cartId) {
        try(Connection con = DBConnection.getConnection()) {
            String sql = "DELETE FROM cart WHERE cartId=?";
            PreparedStatement ps = con.prepareStatement(sql);
            ps.setInt(1, cartId);
            return ps.executeUpdate() > 0;
        } catch(Exception e) {
            e.printStackTrace();
        }
        return false;
    }

    @Override
    public List<Cart> getCartByUser(int userId) {
        List<Cart> list = new ArrayList<>();
        try(Connection con = DBConnection.getConnection()) {
            String sql = "SELECT * FROM cart WHERE userId=?";
            PreparedStatement ps = con.prepareStatement(sql);
            ps.setInt(1, userId);
            ResultSet rs = ps.executeQuery();
            while(rs.next()) {
                Cart c = new Cart();
                c.setCartId(rs.getInt("cartId"));
                c.setUserId(rs.getInt("userId"));
                c.setMenuId(rs.getInt("menuId"));
                c.setQuantity(rs.getInt("quantity"));
                list.add(c);
            }
        } catch(Exception e) { e.printStackTrace(); }
        return list;
    }

    @Override
    public boolean clearCart(int userId) {
        try(Connection con = DBConnection.getConnection()) {
            String sql = "DELETE FROM cart WHERE userId=?";
            PreparedStatement ps = con.prepareStatement(sql);
            ps.setInt(1, userId);
            return ps.executeUpdate() > 0;
        } catch(Exception e) { e.printStackTrace(); }
        return false;
    }

    @Override
    public int getCartCount(int userId) {
        try(Connection con = DBConnection.getConnection()) {
            String sql = "SELECT SUM(quantity) as total FROM cart WHERE userId=?";
            PreparedStatement ps = con.prepareStatement(sql);
            ps.setInt(1, userId);
            ResultSet rs = ps.executeQuery();
            if(rs.next()) return rs.getInt("total");
        } catch(Exception e) { e.printStackTrace(); }
        return 0;
    }

    @Override
    public boolean removeFromCart(Integer userId, int menuId) {
        try(Connection con = DBConnection.getConnection()) {
            String sql = "DELETE FROM cart WHERE userId=? AND menuId=?";
            PreparedStatement ps = con.prepareStatement(sql);
            ps.setInt(1, userId);
            ps.setInt(2, menuId);
            return ps.executeUpdate() > 0;
        } catch(Exception e) { e.printStackTrace(); }
        return false;
    }
}
